# HÆ°á»›ng Dáº«n Sá»­ Dá»¥ng Chá»©c NÄƒng Nháº¯n Tin

## ğŸ“± Tá»•ng Quan

Chá»©c nÄƒng nháº¯n tin Ä‘Ã£ Ä‘Æ°á»£c tÃ­ch há»£p hoÃ n toÃ n vÃ o á»©ng dá»¥ng cá»§a báº¡n, cho phÃ©p ngÆ°á»i dÃ¹ng:
- Xem danh sÃ¡ch cuá»™c há»™i thoáº¡i
- Chat vá»›i báº¡n bÃ¨
- Gá»­i vÃ  nháº­n tin nháº¯n real-time (tá»± Ä‘á»™ng cáº­p nháº­t má»—i 3 giÃ¢y)
- Xem lá»‹ch sá»­ tin nháº¯n vá»›i pagination

## ğŸ¯ CÃ¡ch Truy Cáº­p Chá»©c NÄƒng

### CÃ¡ch 1: Tá»« Bottom Navigation Bar
1. Má»Ÿ á»©ng dá»¥ng
2. NhÃ¬n xuá»‘ng thanh navigation á»Ÿ dÆ°á»›i cÃ¹ng
3. Chá»n tab **"Tin nháº¯n"** (icon chat)
4. Báº¡n sáº½ tháº¥y danh sÃ¡ch cÃ¡c cuá»™c há»™i thoáº¡i

### CÃ¡ch 2: Tá»« MÃ n HÃ¬nh Báº¡n BÃ¨
1. Má»Ÿ tab **"Báº¡n bÃ¨"** tá»« bottom navigation
2. TÃ¬m báº¡n bÃ¨ muá»‘n nháº¯n tin
3. Nháº¥n vÃ o **icon chat** (ğŸ’¬) bÃªn cáº¡nh tÃªn báº¡n bÃ¨
4. Sáº½ má»Ÿ mÃ n hÃ¬nh chat ngay láº­p tá»©c

## ğŸ“‹ CÃ¡c MÃ n HÃ¬nh

### 1. Danh SÃ¡ch Cuá»™c Há»™i Thoáº¡i (Conversations List)

**Hiá»ƒn thá»‹:**
- Avatar vá»›i chá»¯ cÃ¡i Ä‘áº§u cá»§a tÃªn (initials)
- TÃªn ngÆ°á»i báº¡n
- Tin nháº¯n cuá»‘i cÃ¹ng
- Thá»i gian tin nháº¯n cuá»‘i (hÃ´m nay hiá»ƒn thá»‹ giá», hÃ´m qua, hoáº·c ngÃ y/thÃ¡ng/nÄƒm)

**Thao tÃ¡c:**
- **Tap vÃ o cuá»™c há»™i thoáº¡i**: Má»Ÿ chat vá»›i ngÆ°á»i Ä‘Ã³
- **Pull down**: Refresh danh sÃ¡ch
- **NÃºt refresh**: Cáº­p nháº­t danh sÃ¡ch thá»§ cÃ´ng

**Tráº¡ng thÃ¡i:**
- Náº¿u chÆ°a cÃ³ cuá»™c há»™i thoáº¡i: Hiá»ƒn thá»‹ "ChÆ°a cÃ³ cuá»™c há»™i thoáº¡i nÃ o"
- Náº¿u cÃ³ lá»—i: Hiá»ƒn thá»‹ thÃ´ng bÃ¡o lá»—i vá»›i nÃºt "Thá»­ láº¡i"

### 2. MÃ n HÃ¬nh Chat

**Hiá»ƒn thá»‹:**
- Tin nháº¯n cá»§a báº¡n: BÃªn pháº£i, mÃ u xanh
- Tin nháº¯n cá»§a ngÆ°á»i khÃ¡c: BÃªn trÃ¡i, mÃ u xÃ¡m
- NgÃ y thÃ¡ng phÃ¢n cÃ¡ch giá»¯a cÃ¡c tin nháº¯n
- Thá»i gian gá»­i má»—i tin nháº¯n

**Thao tÃ¡c:**
- **Nháº­p tin nháº¯n**: GÃµ vÃ o Ã´ text á»Ÿ dÆ°á»›i cÃ¹ng
- **Gá»­i tin nháº¯n**: 
  - Nháº¥n nÃºt Send (icon mÃ¡y bay giáº¥y)
  - Hoáº·c nháº¥n Enter trÃªn bÃ n phÃ­m
- **Xem tin nháº¯n cÅ©**: Scroll lÃªn Ä‘áº§u, há»‡ thá»‘ng tá»± Ä‘á»™ng load thÃªm tin nháº¯n cÅ©
- **Xem tin nháº¯n má»›i**: Tá»± Ä‘á»™ng cáº­p nháº­t má»—i 3 giÃ¢y

**TÃ­nh nÄƒng Ä‘áº·c biá»‡t:**
- Loading indicator khi Ä‘ang gá»­i tin nháº¯n
- Loading indicator khi Ä‘ang load tin nháº¯n cÅ©
- Tá»± Ä‘á»™ng scroll xuá»‘ng khi gá»­i tin nháº¯n má»›i
- Tá»± Ä‘á»™ng dá»«ng polling khi rá»i khá»i mÃ n hÃ¬nh (tiáº¿t kiá»‡m pin vÃ  data)

## ğŸ” YÃªu Cáº§u

### Äá»ƒ sá»­ dá»¥ng chá»©c nÄƒng nháº¯n tin:
1. **ÄÃ£ Ä‘Äƒng nháº­p**: Pháº£i cÃ³ tÃ i khoáº£n vÃ  Ä‘Ã£ Ä‘Äƒng nháº­p
2. **ÄÃ£ káº¿t báº¡n**: Chá»‰ cÃ³ thá»ƒ nháº¯n tin vá»›i ngÆ°á»i Ä‘Ã£ lÃ  báº¡n bÃ¨
3. **CÃ³ káº¿t ná»‘i internet**: Cáº§n máº¡ng Ä‘á»ƒ gá»­i vÃ  nháº­n tin nháº¯n

### Backend API
- Backend pháº£i Ä‘ang cháº¡y vÃ  cÃ³ thá»ƒ truy cáº­p
- API endpoints:
  - POST `/api/Message/send`
  - GET `/api/Message/history/{friendUsername}`
  - GET `/api/Message/conversations`
  - GET `/api/Message/new/{friendUsername}`

## ğŸš€ CÃ¡ch Test Chá»©c NÄƒng

### Test CÆ¡ Báº£n:
1. ÄÄƒng nháº­p vá»›i 2 tÃ i khoáº£n khÃ¡c nhau (trÃªn 2 thiáº¿t bá»‹ hoáº·c emulator)
2. Káº¿t báº¡n vá»›i nhau
3. Tá»« tÃ i khoáº£n 1: VÃ o tab "Báº¡n bÃ¨" â†’ Nháº¥n icon chat cá»§a tÃ i khoáº£n 2
4. Gá»­i tin nháº¯n "Hello"
5. Tá»« tÃ i khoáº£n 2: VÃ o tab "Tin nháº¯n" â†’ Tháº¥y cuá»™c há»™i thoáº¡i má»›i
6. Má»Ÿ cuá»™c há»™i thoáº¡i â†’ Tháº¥y tin nháº¯n "Hello"
7. Reply láº¡i â†’ TÃ i khoáº£n 1 tá»± Ä‘á»™ng nháº­n Ä‘Æ°á»£c (sau tá»‘i Ä‘a 3 giÃ¢y)

### Test Pagination:
1. Gá»­i hÆ¡n 50 tin nháº¯n
2. Má»Ÿ láº¡i cuá»™c há»™i thoáº¡i
3. Scroll lÃªn Ä‘áº§u â†’ Tin nháº¯n cÅ© sáº½ tá»± Ä‘á»™ng load

### Test UI States:
1. **Loading**: Má»Ÿ á»©ng dá»¥ng láº§n Ä‘áº§u â†’ Tháº¥y loading spinner
2. **Empty**: XÃ³a háº¿t cuá»™c há»™i thoáº¡i â†’ Tháº¥y "ChÆ°a cÃ³ cuá»™c há»™i thoáº¡i nÃ o"
3. **Error**: Táº¯t backend â†’ Tháº¥y thÃ´ng bÃ¡o lá»—i
4. **Sending**: Gá»­i tin nháº¯n â†’ Tháº¥y loading á»Ÿ nÃºt Send

## âš™ï¸ Cáº¥u HÃ¬nh

### API URL
Cáº¥u hÃ¬nh trong file `.env`:
```
BASE_URL=https://your-api-url.com/api
```

### Polling Interval
Hiá»‡n táº¡i: 3 giÃ¢y (cÃ³ thá»ƒ thay Ä‘á»•i trong `message_provider.dart`):
```dart
Timer.periodic(const Duration(seconds: 3), (timer) {
  _checkForNewMessages(friendUsername);
});
```

### Page Size
Hiá»‡n táº¡i: 50 tin nháº¯n má»—i láº§n (cÃ³ thá»ƒ thay Ä‘á»•i trong `message_service.dart`):
```dart
int pageSize = 50
```

## â— Xá»­ LÃ½ Lá»—i

### Lá»—i "Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i"
**NguyÃªn nhÃ¢n**: Token háº¿t háº¡n hoáº·c khÃ´ng há»£p lá»‡
**Giáº£i phÃ¡p**: ÄÄƒng xuáº¥t vÃ  Ä‘Äƒng nháº­p láº¡i

### Lá»—i "Chá»‰ cÃ³ thá»ƒ nháº¯n tin vá»›i báº¡n bÃ¨"
**NguyÃªn nhÃ¢n**: ChÆ°a káº¿t báº¡n vá»›i ngÆ°á»i nháº­n
**Giáº£i phÃ¡p**: Gá»­i lá»i má»i káº¿t báº¡n vÃ  Ä‘á»£i cháº¥p nháº­n

### Lá»—i "KhÃ´ng thá»ƒ gá»­i tin nháº¯n"
**NguyÃªn nhÃ¢n**: 
- Máº¥t káº¿t ná»‘i internet
- Backend khÃ´ng hoáº¡t Ä‘á»™ng
- Ná»™i dung tin nháº¯n khÃ´ng há»£p lá»‡

**Giáº£i phÃ¡p**:
1. Kiá»ƒm tra káº¿t ná»‘i internet
2. Kiá»ƒm tra backend cÃ³ cháº¡y khÃ´ng
3. Thá»­ gá»­i láº¡i

### Tin nháº¯n khÃ´ng tá»± Ä‘á»™ng cáº­p nháº­t
**NguyÃªn nhÃ¢n**:
- Äang á»Ÿ ngoÃ i mÃ n hÃ¬nh chat
- Polling bá»‹ dá»«ng

**Giáº£i phÃ¡p**:
- Quay láº¡i mÃ n hÃ¬nh chat
- Pull to refresh
- Má»Ÿ láº¡i mÃ n hÃ¬nh

## ğŸ“Š Luá»“ng Dá»¯ Liá»‡u

```
User Action â†’ UI Screen â†’ Provider â†’ Service â†’ Backend API
                â†“            â†“          â†“
              Update    Manage State  HTTP Request
                UI
```

### Khi gá»­i tin nháº¯n:
1. User nháº­p vÃ  nháº¥n Send
2. ChatScreen gá»i `provider.sendMessage()`
3. MessageProvider gá»i `service.sendMessage()`
4. MessageService gá»­i POST request Ä‘áº¿n backend
5. Backend tráº£ vá» MessageDto
6. Provider cáº­p nháº­t `_currentMessages`
7. Provider notify listeners
8. UI tá»± Ä‘á»™ng rebuild vÃ  hiá»ƒn thá»‹ tin nháº¯n má»›i

### Khi nháº­n tin nháº¯n (polling):
1. Timer cháº¡y má»—i 3 giÃ¢y
2. Provider gá»i `service.getNewMessages()`
3. MessageService gá»­i GET request vá»›i lastMessageId
4. Backend tráº£ vá» danh sÃ¡ch tin nháº¯n má»›i (náº¿u cÃ³)
5. Provider thÃªm tin nháº¯n má»›i vÃ o `_currentMessages`
6. Provider notify listeners
7. UI tá»± Ä‘á»™ng rebuild vÃ  hiá»ƒn thá»‹ tin nháº¯n má»›i

## ğŸ¨ Customization

### Thay Ä‘á»•i mÃ u sáº¯c:
**File**: `lib/screens/messages/chat_screen.dart`

Tin nháº¯n cá»§a mÃ¬nh:
```dart
color: Colors.blue.shade600  // Äá»•i mÃ u táº¡i Ä‘Ã¢y
```

Tin nháº¯n ngÆ°á»i khÃ¡c:
```dart
color: Colors.grey.shade300  // Äá»•i mÃ u táº¡i Ä‘Ã¢y
```

### Thay Ä‘á»•i avatar:
**File**: `lib/screens/messages/conversations_list_screen.dart`

```dart
CircleAvatar(
  radius: 28,  // Äá»•i kÃ­ch thÆ°á»›c
  backgroundColor: Colors.blue.shade700,  // Äá»•i mÃ u ná»n
  child: Text(
    initials ?? username.substring(0, 1).toUpperCase(),
    style: const TextStyle(
      color: Colors.white,  // Äá»•i mÃ u chá»¯
      fontSize: 20,  // Äá»•i cá»¡ chá»¯
    ),
  ),
)
```

### Thay Ä‘á»•i format thá»i gian:
**File**: `lib/screens/messages/chat_screen.dart`

```dart
String _formatMessageTime(DateTime dateTime) {
  // Custom format táº¡i Ä‘Ã¢y
  return DateFormat('HH:mm').format(dateTime);
}
```

## ğŸ“ Code Examples

### Má»Ÿ chat programmatically:
```dart
Navigator.push(
  context,
  MaterialPageRoute(
    builder: (context) => ChatScreen(
      friendUsername: 'john_doe',
      friendInitials: 'JD',
    ),
  ),
);
```

### Gá»­i tin nháº¯n programmatically:
```dart
final provider = context.read<MessageProvider>();
bool success = await provider.sendMessage('john_doe', 'Hello!');
if (success) {
  print('Tin nháº¯n Ä‘Ã£ gá»­i thÃ nh cÃ´ng');
}
```

### Refresh danh sÃ¡ch cuá»™c há»™i thoáº¡i:
```dart
final provider = context.read<MessageProvider>();
await provider.loadConversations();
```

## ğŸ” Debug Tips

### Báº­t debug logs:
ThÃªm print statements vÃ o cÃ¡c phÆ°Æ¡ng thá»©c trong MessageProvider:
```dart
Future<void> loadConversations() async {
  print('ğŸ“± Loading conversations...');
  // ... code ...
  print('âœ… Conversations loaded: ${_conversations.length}');
}
```

### Kiá»ƒm tra API response:
Trong MessageService, print response:
```dart
print('API Response: ${response.body}');
```

### Kiá»ƒm tra token:
```dart
final token = await _getToken();
print('Current token: $token');
```

## ğŸ“ Best Practices

1. **LuÃ´n kiá»ƒm tra mounted trÆ°á»›c khi setState**
2. **Dispose timer vÃ  controller Ä‘Ãºng cÃ¡ch**
3. **Handle loading vÃ  error states**
4. **Validate input trÆ°á»›c khi gá»­i**
5. **Sá»­ dá»¥ng const constructors khi cÃ³ thá»ƒ**
6. **TrÃ¡nh rebuild khÃ´ng cáº§n thiáº¿t**

## ğŸ“ Há»— Trá»£

Náº¿u gáº·p váº¥n Ä‘á»:
1. Kiá»ƒm tra console logs
2. Kiá»ƒm tra backend logs
3. Kiá»ƒm tra network requests (DevTools)
4. Äá»c láº¡i documentation nÃ y
5. Kiá»ƒm tra code trong cÃ¡c file Ä‘Ã£ táº¡o

---

**ChÃºc báº¡n thÃ nh cÃ´ng vá»›i chá»©c nÄƒng nháº¯n tin! ğŸ‰**

